package com.dreamsecurity.ca.ext.service;

import java.io.IOException;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;

import org.springframework.stereotype.Service;

import com.dreamsecurity.ca.business.user.service.UserService;
import com.dreamsecurity.ca.business.user.vo.UserVo;
import com.dreamsecurity.ca.ext.dao.MagicKmsAgentDao;
import com.dreamsecurity.ca.ext.vo.KeyOwnerVo;
import com.dreamsecurity.ca.ext.vo.KmsApiDto;
import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;

@Service
public class MagicKmsAgentService {
	
	@Inject 
	private UserService userService;
	
	@Inject
	private MagicKmsAgentDao agentDao;
	
	public String showUserAuthVal( HttpServletRequest request, String userUid ) throws JsonParseException, JsonMappingException, IOException {
		UserVo userVo = new UserVo();
		
		userVo.setLoginId( userUid );
		userVo = userService.selectOneUser( userVo );
		
		return userVo.getPassword();
	}
	
	public boolean isUserAuthorized( HttpServletRequest request, String keyUid ) throws JsonParseException, JsonMappingException, IOException {
		ObjectMapper mapper = new ObjectMapper();
		KmsApiDto dto = mapper.readValue( request.getReader(), KmsApiDto.class );
		KeyOwnerVo keyOwnerVo = new KeyOwnerVo();
		
		keyOwnerVo.setKeyUid( keyUid );
		keyOwnerVo.setUserUid( dto.getUserUid() );
		
		keyOwnerVo = agentDao.selectKeyOwnerUsingUserUid( keyOwnerVo );
		
		if ( keyOwnerVo != null ) {
			return true;
		} else {
			return false;
		}
	}
}
